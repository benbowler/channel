// App!
function app(){function e(){console.log("loading video + next virtual page."),jQuery("#player-yt").tubeplayer("pause"),$.ajax({type:"POST",dataType:"json",url:"/api:video",success:function(e){console.log(e),jQuery("#player-yt").tubeplayer("play",e.media$group.yt$videoid.$t),$.video={_id:e._id,slug:e.slug,title:e.title.$t,author:e.author[0].name.$t,description:e.media$group.media$description.$t,html_description:e.html_description,picture:e.media$group.media$thumbnail[1].url},$.user.logged_in&&History.pushState(e,"â–º "+e.title.$t+" | "+$.site.title,e.slug),$("#video_title").html(e.title.$t),$("#video_author").html(e.author[0].name.$t),$("#video_description").html(e.html_description),$(".channel").attr("href","http://youtube.com/user/"+e.author[0].name.$t);var t=e.media$group.media$thumbnail[1].url.replace("http","https");console.log(t),$("#background-blur").css("background-image","url("+t+")"),_gaq.push(["_trackPageview","/"+e.slug]),requestData={user:$.user._id,video:$.video._id},$.ajax({type:"POST",dataType:"json",data:requestData,url:"/api:lovestate",success:function(e){e.response===!0?$(".love").html("loved"):$(".love").html("love")}}),$(".skip").html("skip"),console.log("wait 12 seconds"),setTimeout(function(){i("watch.video","play")},12e3)},error:function(e){console.log("error"+e),$.alertify.error("error loading video :(")}})}function t(e){console.log("Changing video state:"+e),requestData={user:$.user._id,video:$.video._id},e=="love"?($(".love").html("loving"),requestUrl="/api:love"):($(".love").html("meh"),requestUrl="/api:unlove"),$.ajax({type:"POST",data:requestData,url:requestUrl,success:function(t){e=="love"?(s("love","+10 point for loving"),u("eatbass:love"),$(".love").html("loved")):$(".love").html("love")},error:function(e){$.alertify.error("error lovering track :("),$(".love").html("love")}})}function n(){console.log("Sharing video "+document.URL),FB.ui({method:"feed",name:$.video.title+" "+$.site.title,picture:$.video.picture,link:document.URL,caption:"dicover more like "+$.video.title+" on #eatbass and win music, merch and tickets."},function(e){e?(s("share","+50 point for sharing"),console.log("Shared "+e)):console.log("Share canceled")})}function r(){return FB.ui({method:"apprequests",message:"win music, tickets and merch by listening to the music you love",filters:["app_non_users"],title:"#eatbass bass music tv"},function(e){if(!e||!e.request_ids)return!1;var t=String(requests).split(",").length;s("invite","+50 for inviting friends","thanks for inviting friends")}),!1}function i(e,t){console.log("doActions triggered"),s("play","+1 point for watching"),$("#video_status").html("posting watch action to facebook.."),u("video.watches")}function s(e,t,n){console.log("registerring points: "+e),requestData={method:e,user:$.user._id,video:$.video._id},console.log(requestData),$.ajax({type:"POST",dataType:"json",data:requestData,url:"/api:points",success:function(e){console.log("scored points "+e),e.response===!0?($.alertify.log(t),o()):n&&$.alertify.log(n)},error:function(e){console.log("failed connecting to api"),$.alertify.log("error connecting to #eatbass")}})}function o(){console.log("updating user points"),requestData={user:$.user._id},console.log("updating user points"+requestData),$.ajax({type:"POST",data:requestData,url:"/api:userpoints",success:function(e){console.log(e),e===0?setTimeout(o(),1e3):($("#points").html(e),$("#points").fadeOut(100).fadeIn(500))}})}function u(e){e=="video.watches"&&(openGraphRecipe={video:document.URL}),e=="eatbass:love"&&(openGraphRecipe={other:document.URL}),console.log(e),console.log(openGraphRecipe),FB.api("/me/"+e,"post",openGraphRecipe,function(e){console.log(e),!e||e.error?(console.log("Open Graph error occured"),$("#video_status").show().html("")):(console.log("Action was successful! Action ID: "+e.id),$("facebook-status").html('watch action posted to facebook. <a href="#" onclick="deleteOpenGraph('+e.id+')">delete</a>'))})}function a(e){requestData={object:e},$.ajax({type:"POST",data:requestData,url:"/api:deleteopengraph",success:function(e){$("facebook-status").html("watch action deleted")},error:function(e){}})}function f(){console.log("loading profile"),$("#profile").fadeIn(),requestData={user:$.user._id},$.ajax({type:"POST",data:requestData,url:"/api:profile",success:function(e){$("#profile_videos").html(e)},error:function(e){$.alertify.error("error loading profile :(")}})}function l(e){console&&console.log&&console.log("The response was",e)}function c(){FB.login(function(e){var t=[location.protocol,"//",location.host,"/",$.video.slug].join("");window.location=t},{scope:"email,user_likes,publish_actions"})}$.user.logged_in?($.tubeplayer.defaults.afterReady=function(e){jQuery("#player-yt").tubeplayer("unmute"),s("return","+20 for logging in today","come back again tomorrow for +20"),$("#login").fadeOut()},$.alertify.log("welcome to #eatbass"),$("#background-blur").blurjs({source:"body",radius:20,overlay:"rgba(255,255,255,0.4)"})):($.tubeplayer.defaults.afterReady=function(e){jQuery("#player-yt").tubeplayer("mute")},$("#page-blur").blurjs()),jQuery("#player-yt").tubeplayer({width:"100%",height:"100%",allowFullScreen:"true",showControls:0,autoPlay:!0,showInfo:!1,protocol:"https",theme:"light",color:"white",modestbranding:!1,initialVideo:$.video.ytID,preferredQuality:"default",onPlayerEnded:e,onErrorNotFound:e,onErrorNotEmbeddable:e,onErrorInvalidParameter:e,mute:!0}),$(".skip").click(function(t){t.preventDefault(),$(".skip").html("skipping"),e()}),$(".love").click(function(e){e.preventDefault();var n=$(".love").html();t(n)}),$(".share").click(function(e){e.preventDefault(),n()}),$(".profile").click(function(e){e.preventDefault()}),$(".profile-exit").click(function(e){e.preventDefault(),$("#profile").fadeOut()}),$(".fb-js-login").click(function(e){e.preventDefault(),c()}),$(".recommend").click(function(){FB.ui({method:"apprequests",message:$(this).attr("data-message")},function(e){e!==null&&l(e)})})};